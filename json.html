<!DOCTYPE html>
<html>
<head>

    <script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-76519362-1', 'auto');
    ga('send', 'pageview');

    //HotJar Tracking

    (function (h, o, t, j, a, r) {
        h.hj = h.hj || function () {
            (h.hj.q = h.hj.q || []).push(arguments)
        };
        h._hjSettings = {
            hjid: 200722,
            hjsv: 5
        };
        a = o.getElementsByTagName('head')[0];
        r = o.createElement('script');
        r.async = 1;
        r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
        a.appendChild(r);
    })(window, document, '//static.hotjar.com/c/hotjar-', '.js?sv=');
    </script>
    <title>Formatted Text to Minecraft JSON by CommandFox</title>
    <link rel="stylesheet" href="style.css" media="none" onload="if(media!='all')media='all'">
    <noscript><link rel="stylesheet" href="style.css"></noscript>
</head>
<body>
	<div id="outer">
    <div id="cont">
        <a href="index.html" id="back-home">&#8619; Return
        to Home</a>
        <script>
        function pegasus(a, b) {
            return b = new XMLHttpRequest, b.open("GET", a), a = [], b.onreadystatechange = b.then = function (c, d, e, f) {
                if (c && c.call && (a = [, c, d]), 4 == b.readyState && (e = a[0 | b.status / 200])) {
                    try {
                        f = JSON.parse(b.responseText)
                    } catch (g) {
                        f = null
                    }
                    e(f, b)
                }
            }, b.send(), b
        };
        </script>
        <br/><h2>Created by CommandFox</h1>
        <p class="info">
			Enter the text into the following box.
			<br/>Color and formatting codes are allowed (using an & sign), e.g. <span style="color:#ECA517">&6Gold</span>.
			<br/> Player and entity selectors are also allowed, e.g. <span style="color:#8C8C8C">@p</span> and <span style="color:#8C8C8C">@a[score_example_min=1]</span>.
			<br/> To show the value of a scoreboard objective of a specific player or entity, add a <span style="color:#8C8C8C">-></span> after a selector, followed by a scoreboard objective's name, e.g. <span style="color:#8C8C8C">@p->kills</span> and <span style="color:#8C8C8C">@a[score_deaths_min=1]->deaths</span>.
		</p>
		<input class="text" id="text" placeholder="Text, with formatting codes and selectors." type="text">
		<button class="sub" id="sub">Generate Command</button>
		<span id="yrcmd" style="display:none">Your Command</span>
		<textarea id="res" readonly style="display:none;"></textarea>
    </div>
	</div>
    <script>
    function parse(string) {
        var getText = function (text) {
            var result = "";
            while (text[0] != "&" && text.length > 0 && text[0] != "@") {
                //console.log(result);
                result += text.substring(0, 1);
                text = text.substring(1);
            }
            return {
                text: result,
                rest: text
            };
        };
        if (!/\&|\@/.test(string)) {
            return [string];
        } else {
            var colors = {
                "&0": "black",
                "&1": "dark_blue",
                "&2": "dark_green",
                "&3": "dark_aqua",
                "&4": "dark_red",
                "&5": "dark_purple",
                "&6": "gold",
                "&7": "gray",
                "&8": "dark_gray",
                "&9": "blue",
                "&a": "green",
                "&b": "aqua",
                "&c": "red",
                "&d": "light_purple",
                "&e": "yellow",
                "&f": "white"
            };
            var options = {
                "&l": "bold",
                "&n": "underlined",
                "&o": "italic",
                "&k": "obfuscated",
                "&m": "strikethrough"
            };
            var result = [];
            var text = getText(string);
            var current = {
                color: "none"
            };
            var nextCurrent = {};
            console.log(text.text);
            result.push(text.text);
            string = text.rest;
            loop1: while (string.length > 0) {
                nextCurrent.color = "none";
                current = nextCurrent;
                nextCurrent = {};
                loop2: while (string[0] == "&") {
                    if (typeof colors[string.substring(0, 2)] === "string") {
                        current.color = colors[string.substring(0, 2)];
                        string = string.substring(2);
                    } else if (typeof options[string.substring(0, 2)] === "string") {
                        current[options[string.substring(0, 2)]] = true;
                        nextCurrent[options[string.substring(0, 2)]] = false;
                        string = string.substring(2);
                    } else if (string.substring(0, 2) === "&r") {
                        string = string.substring(2);
                        break;
                    }
                }
                if (string[0] == "@" && /[a-zA-Z]/.test(string[1])) {
                    var selector = "@" + string[1];
                    if (string[2] == "[") {
                        string = string.substring(3);
                        selector += "[";
                        while (string[0] != "]") {
                            selector += string[0];
                            string = string.substring(1);
                        }
						console.log(string[0]);
						current.selector = selector + "]";
						if (string[1] == "-" && string[2] == ">") {
							string = string.substring(3);
							var score = {name:selector+"]"};
							var objective = "";
							while (string[0] != " " && string != "") {
								objective += string[0];
								string = string.substring(1);
							}
							score.objective = objective;
							current.score = score;
							delete current["selector"];
						}

                    } else if (string[2] == "-" && string[3] == ">") {
						string = string.substring(4);
						var score = {name:selector};
						var objective = "";
						while (string[0] != " " && string != "") {
                            objective += string[0];
                            string = string.substring(1);
                        }
						score.objective = objective;
						current.score = score;
						delete current["selector"];
					} else {
                        string = string.substring(2);
                        current.selector = selector;
                    }
                }
				console.log(string);
				var text = getText(string);
				current.text = text.text;
                if (current.selector) {
					var next = JSON.stringify(current);
                    delete current["text"];
					result.push(current);
					current = JSON.parse(next);
					delete current["selector"];
                } else if(current.score) {
					var next = JSON.stringify(current);
                    delete current["text"];
					result.push(current);
					current = JSON.parse(next);
					delete current["score"];
				}
				result.push(current);
				string = text.rest;
                console.log(current);
            }
			if(result[0] == "" || ( typeof result[0] !== "string" && !result[0].text && !result[0].selector && !result[0].score ) ){
				result.shift();
			}
			var lastres = result[ result.length - 1 ];
			if(lastres == "" || ( typeof lastres !== "string" && !lastres.text && !lastres.selector && !lastres.score ) ){
				result.pop();
			}
            return result;
        }
    }
    document.getElementById("sub").onclick = function () {
        var entered = document.getElementById("text").value;
        var res = document.getElementById("res");
        res.style.display = "block";
        document.getElementById("yrcmd").style.display = "block";
        var intext = ('innerText' in res) ? 'innerText' : 'textContent';

        res[intext] = JSON.stringify(parse(entered));
    }
    </script>
</body>
</html>
